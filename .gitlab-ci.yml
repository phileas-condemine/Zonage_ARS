image: rocker/tidyverse

stages:
  - setup_and_test


# To have the coverage percentage appear as a gitlab badge follow these
# instructions:
# https://docs.gitlab.com/ee/user/project/pipelines/settings.html#test-coverage-parsing
# The coverage parsing string is
# Coverage: \d+\.\d+

install_test:
  stage: setup_and_test
  only:
      - master
  script:
      - sudo apt-get update -y
      - sudo apt-get install -y libudunits2-dev
      - sudo apt-get install -y libgdal-dev
      - sudo apt-get install -y gdal-bin
      - sudo apt-get install -y libgeos-dev
      - sudo apt-get install -y libproj-dev
      - Rscript install_deps.R
      - R -e "webshot::install_phantomjs()"
      - base64 $DROPTOKEN -d > droptoken.rds
      - sudo cp $gm_credentials > credentials.json
      - mkdir .secrets
      - base64 $GMSECRET -d > .secrets/fbc5fe5f1b9501fb39a3686784bf63a1_drees.zonage.ars@gmail
      - Rscript run_tests.R

